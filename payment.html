<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pembayaran</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  background:#000;
  position:relative;
  color:#fff;
}

canvas{
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  z-index:0;
}

.card{
  position:relative;
  z-index:1;
  background:#111;
  padding:25px;
  border-radius:18px;
  width:100%;
  max-width:400px;
  text-align:center;
  box-shadow:0 15px 30px rgba(0,0,0,.4);
}

input,select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-top:10px;
}

button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  margin-top:10px;
  font-weight:bold;
  cursor:pointer;
}

.btn-primary{background:#007bff;color:white;}
.btn-success{background:#28a745;color:white;}
.btn-danger{background:#ff4d4d;color:white;}
.btn-secondary{background:#6c757d;color:white;}

.hidden{display:none;}

.timer{
  margin-top:10px;
  font-weight:bold;
  color:#0d6efd;
}

.data-box{
  text-align:left;
  margin-bottom:15px;
  font-size:14px;
}
</style>
</head>
<body>

<canvas id="meteorCanvas"></canvas>

<div class="card">

  <!-- SLIDE 1 -->
  <div id="slide1">
    <h2>Pembayaran</h2>
    <input type="text" id="userId" placeholder="Masukkan Nomor / ID">
    <select id="metode">
      <option value="">-- Pilih Metode --</option>
      <option value="QRIS">QRIS</option>
      <option value="DANA">DANA</option>
    </select>
    <button class="btn-primary" onclick="lanjut()">Lanjut</button>
  </div>

  <!-- SLIDE 2 -->
  <div id="slide2" class="hidden">
    <div class="data-box">
      <p><strong>Produk:</strong> <span id="namaProduk"></span></p>
      <p><strong>Nominal:</strong> <span id="hargaProduk"></span></p>
      <p><strong>Metode:</strong> <span id="metodeText"></span></p>
      <p><strong>Nomor/ID:</strong> <span id="idText"></span></p>
    </div>

    <div id="qrisBox" class="hidden">
      <img id="qrisImg" src="https://smail.my.id/cloud/E2UAiOSi1" width="220">
      <button class="btn-secondary" onclick="downloadQR()">Download QRIS</button>
    </div>

    <div id="danaBox" class="hidden">
      <p style="font-size:18px;color:blue;font-weight:bold;">085860605722</p>
    </div>

    <input type="file" id="bukti" accept="image/*">

    <div class="timer">Waktu tersisa: <span id="timer">05:00</span></div>

    <button class="btn-success" onclick="kirimTelegram()">Konfirmasi Pembayaran</button>
    <button class="btn-primary" onclick="gantiMetode()">Ganti Metode</button>
    <button class="btn-danger" onclick="batal()">Batal</button>
  </div>

</div>

<script>
const BOT_TOKEN = "8201023435:AAF9OdK3PJOsDE8Dqlc6cptUBxevYPyytPg";
const CHAT_ID = "7991119367";

const params = new URLSearchParams(window.location.search);
const paket = params.get("paket");
const harga = params.get("harga");

let metodeDipilih = "";
let userIdGlobal = "";
let timerInterval;

/* SLIDE 1 -> 2 */
function lanjut(){
  const userId = document.getElementById("userId").value.trim();
  const metode = document.getElementById("metode").value;

  if(!userId) return alert("Masukkan Nomor / ID!");
  if(!metode) return alert("Pilih metode pembayaran!");

  userIdGlobal = userId;
  metodeDipilih = metode;

  document.getElementById("slide1").classList.add("hidden");
  document.getElementById("slide2").classList.remove("hidden");

  document.getElementById("namaProduk").innerText = paket;
  document.getElementById("hargaProduk").innerText =
    "Rp " + Number(harga).toLocaleString("id-ID");
  document.getElementById("metodeText").innerText = metodeDipilih;
  document.getElementById("idText").innerText = userIdGlobal;

  if(metodeDipilih === "QRIS"){
    document.getElementById("qrisBox").classList.remove("hidden");
    document.getElementById("danaBox").classList.add("hidden");
  } else {
    document.getElementById("danaBox").classList.remove("hidden");
    document.getElementById("qrisBox").classList.add("hidden");
  }

  startTimer(5 * 60);
}

function gantiMetode(){
  document.getElementById("slide2").classList.add("hidden");
  document.getElementById("slide1").classList.remove("hidden");
  clearInterval(timerInterval);
  document.getElementById("timer").textContent="05:00";
}

function batal(){
  clearInterval(timerInterval);
  window.location.href="index.html";
}

/* TIMER */
function startTimer(duration){
  let time = duration;
  const display = document.getElementById("timer");

  timerInterval = setInterval(()=>{
    let minutes = Math.floor(time/60);
    let seconds = time%60;
    display.textContent =
      (minutes<10?"0":"")+minutes+":"+
      (seconds<10?"0":"")+seconds;

    if(--time<0){
      clearInterval(timerInterval);
      alert("Waktu habis!");
      window.location.href="index.html";
    }
  },1000);
}

/* KIRIM TELEGRAM */
function kirimTelegram(){
  const file = document.getElementById("bukti").files[0];
  if(!file) return alert("Upload bukti transfer dulu!");

  const caption = `
ðŸ§¾ KONFIRMASI PEMBAYARAN
â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ“¦ Paket: ${paket}
ðŸ’° Harga: Rp ${Number(harga).toLocaleString("id-ID")}
ðŸ’³ Metode: ${metodeDipilih}
ðŸ“Œ Nomor/ID: ${userIdGlobal}
â”â”â”â”â”â”â”â”â”â”â”â”
`;

  const formData = new FormData();
  formData.append("chat_id", CHAT_ID);
  formData.append("photo", file);
  formData.append("caption", caption);

  fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendPhoto`,{
    method:"POST",
    body:formData
  })
  .then(res=>res.json())
  .then(()=>window.location.href="success.html")
  .catch(()=>alert("Gagal kirim!"));
}

function downloadQR(){
  const link = document.createElement("a");
  link.href = document.getElementById("qrisImg").src;
  link.download = "qris.png";
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

/* BACKGROUND METEOR */
const canvas = document.getElementById("meteorCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const meteors = [];
for(let i=0;i<60;i++){
  meteors.push({
    x: Math.random()*canvas.width,
    y: Math.random()*canvas.height,
    len: Math.random()*20+10,
    speed: Math.random()*2+1,
    color: Math.random()>0.5?"#fff":"#0af"
  });
}

function drawMeteors(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  meteors.forEach(m=>{
    ctx.beginPath();
    ctx.moveTo(m.x,m.y);
    ctx.lineTo(m.x-m.len,m.y+m.len);
    ctx.strokeStyle=m.color;
    ctx.lineWidth=1.5;
    ctx.stroke();
    m.x -= m.speed;
    m.y += m.speed;
    if(m.x<0||m.y>canvas.height){
      m.x = canvas.width + Math.random()*50;
      m.y = Math.random()*-50;
    }
  });
  requestAnimationFrame(drawMeteors);
}
drawMeteors();
</script>
</body>
</html>